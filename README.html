<!DOCTYPE html>
<html>
<head>
	<title>WEBサーバ構築の内容</title>
</head>
<body>
	<h1 id="WEBサーバ構築の内容">WEBサーバ構築の内容</h1>
        <h2>０, 前提条件</h2>
            <ul>
                <li>Windows10のPCで作業を実施</li>
                <li>東京リージョンで構成。ただしDNSフェイルオーバールーティング先のリージョンはバージニア北部</li>
            </ul>
        <h2>１, 設計の概要</h2>
            <ul>
                <li>全体の構成は、FW⇒LB・webサーバ⇒DBでいづれもマルチAZ構成な3層アーキテクチャ構成となっている</li>
                <li>ACMで証明書を発行し、Route53・ALBに連携したうえで、セキュアなhttps通信を実現</li>
                <li>バックアップはDLMでwebサーバ及び管理サーバのEBSのスナップショットを指定時間ごと自動取得する設定を実施</li>
                <li>管理サーバは複数台構成が不可能の為、バックアップを定期的に実施するアーキテクチャ設計を採用。
                    <br>1時間置きにEBSボリュームのスナップショットを自動取得。</li>
                    <br>
                <li>CloudWatchとSNSを利用してWAFからの不正検知やインスタンスのステータス異常等をいち早く担当者へGmailにて通知</li>
                <li>webサーバがCPU使用率80％を超過した場合AutoScallingでスケーリングし自動的に負荷分散</li>
                <li>データベースはRDSを利用しマルチAZでのマスタースレーブ構成及び、リードレプリカを使用した読み込みの負荷分散を実現</li>
                <li>LBがダウンした場合の暫定措置としてCloudfrontとS3を利用した静的ウェブホスティングをDNSフェイルオーバー先に設定</li>
                <li>FWではWAFによる一般的な攻撃の保護を実現し、WEB層の手前にALBとEC2をマルチAZで2台設置</li>
                <li>他AWSリソースへのアクセス制限はWEBサーバ・管理サーバのみS3へのアクセス許可するIAMポリシー・ロールをアタッチ</li>
            </ul>
        <h2>２, 詳細設計</h2>
            <ul>
                <li><a href="#システム構成図">システム構成図</a></li>
                <li><a href="#ネットワーク構成">ネットワーク構成</a></li>
                <li><a href="#各種サーバの構成">各種サーバの構成</a></li>
                <li><a href="#監視設計">監視設計</a></li>
            </ul>
        <h2 id="システム構成図">～システム構成図～</h2>
	        <img src="https://seitekiweb-cloudfront.s3.ap-northeast-1.amazonaws.com/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%A7%8B%E6%88%90%E5%9B%B3_%E8%A9%A6%E9%A8%93%E8%A7%A3%E7%AD%94.png">
        <br>
        <a href="#WEBサーバ構築の内容">先頭ページに戻る</a>
        <h2 id="ネットワーク構成">～ネットワーク構成～</h2>
            <h3>VPCの構成</h3>
                <ul>
                    <li>VPCは東京リージョンに設置し、CIDRは10.0.0.0/16</li>
                    <li>サブネットはパブリックサブネットとプライベートサブネットで構成しと1aと1cにそれぞれ設置</li>
                </ul>
            <h3>１,ログイン認証サーバ</h3>
                <ul>
                    <li>サブネットはプライベートサブネットを使用し、Availability Zoneは1aと1cに設置</li>
                    <li>CIDRは1aが10.0.0.0/24、1cが10.0.0.2/24</li>
                    <li>セキュリティグループのポートは22/80/443/3306を解放。</li>
                    <li>ネットワーク経路はインターネット経由で0.0.0.0./0で解放。</li>
                </ul>
            <h3>２,管理サーバ</h3>
                <ul>
                    <li>サブネットはプライベートサブネットを使用し、Availability Zoneは1aと1cに設置</li>
                    <li>CIDRは1aが10.0.0.0/24、1cが10.0.0.2/24</li>
                    <li>セキュリティグループのポートは22/80/443/3306を解放。</li>
                    <li>ネットワーク経路は10.0.4.0/24と10.0.5.0/24のみ制限。</li>
                </ul>
            <h3>３,WEBサーバ</h3>
                <ul>
                    <li>サブネットはプライベートサブネットを使用し、Availability Zoneは1aと1cに設置</li>
                    <li>CIDRは1aが10.0.0.0/24、1cが10.0.0.2/24</li>
                    <li>セキュリティグループのポートは22/80/443/3306を解放。</li>
                    <li>ネットワーク経路は10.0.4.0/24と10.0.5.0/24のみ制限。</li>
                </ul>
            <h3>４,DBサーバ</h3>
                <ul>
                    <li>サブネットはプライベートサブネットを使用し、Availability Zoneは1aと1cに設置</li>
                    <li>CIDRは1aが10.0.0.1/24、1cが10.0.0.3/24</li>
                    <li>セキュリティグループはWEBと管理サーバ以外からアクセスできないよう設定し、ポートは22/80/443/3306を解放。</li>
                    <li>アクセス制限は更新系は管理サーバのみとし、参照系は管理・WEBサーバからアクセス可能。</li>
                    <li>ネットワーク経路は10.0.0.0/24と10.0.2.0/24のみ制限。</li>
                </ul>
            <br>
            <a href="#WEBサーバ構築の内容">先頭ページに戻る</a>
        <h2 id="各種サーバの構成">～各種サーバの構成～</h2>
            <h3>１,ログイン認証サーバー</h3>
                <ul>
                    <li>EC2インスタンスを使用</li>
                    <li>OSはLinuxを使用</li>
                    <li>ミドルウェアはApacheを使用し、AMIの詳細設定にApacheインストールのコマンドを事前に組み込んでおく。</li>
                    <li>Availability Zoneは1aと1cに各2つずつEC2インスタンスを配置し２つのAvailability Zone跨ったマルチAZ構成を採用</li>
                    <li>LBやサーバがダウンした場合の暫定措置としてCloudFront+S3で作成した静的WEBサイトへDNSフェイルオーバールーティングを設定。</li>
                    <li>DLMでEBSボリュームのスナップショットをアクセスが少ない夜の時間帯に毎日取得し、取得を完了したらSNSとGmailを使用して担当者へ通知する</li>
                    <li>WAFを手前のALBに連携し、悪意のあるユーザからの攻撃を防ぐ。</li>
                </ul>
            <h3>２,管理サーバの構成</h3>
                <ul>
                    <li>EC2インスタンスを使用</li>
                    <li>OSはLinuxを使用</li>
                    <li>ミドルウェアはApacheを使用し、AMIの詳細設定にApacheインストールのコマンドを事前に組み込んでおく。</li>
                    <li>さらに管理サーバからDBへアクセスが必要になる為、MySQLのインストールが必要なので、MySQLのインストールコマンドもAMIの詳細設定に組み込む。</li>
                    <li>Availability Zoneは1aと1cに各2つずつEC2インスタンスを配置し２つのAvailability Zone跨ったマルチAZ構成を採用</li>
                    <li>LBやサーバがダウンした場合の暫定措置としてCloudFront+S3で作成した静的WEBサイトへDNSフェイルオーバールーティングを設定。</li>
                    <li>画像の容量が増えることを想定し保存先・取り出し先東京リージョンのS3とする</li>
                    <li>複数台構成が不可能な構成となっており、定期的なバックアップが必要となる為、DLMによるEBSボリュームのスナップショットを1時間置きに取得し、
                        <br>取得を完了したらSNSとGmailを使用して担当者へ通知する
                    </li>
                    <br>
                    <li>管理サーバへのアクセス認証はCognitoを使用し、ユーザ名とパスワードに加えMFA認証を加えた2段階認証とすることで管理サーバへのセキュリティを高める。</li>
                    <li>インスタンスサイズはlargeを採用し、メモリ使用率を確保する。</li>
                    <li>他AWSリソースへのアクセス制限はS3へのアクセス許可するIAMポリシー・ロールをアタッチ</li>
                </ul>
            <h3>３,WEBサーバの構成</h3>
                <ul>
                    <li>EC2インスタンスを使用</li>
                    <li>OSはLinuxを使用</li>
                    <li>ミドルウェアはApacheを使用し、AMIの詳細設定にApacheインストールのコマンドを事前に組み込んでおく。</li>
                    <li>さらにWEBサーバからDBへアクセスが必要になる為、MySQLのインストールが必要なので、MySQLのインストールコマンドもAMIの詳細設定に組み込む。</li>
                    <li>Availability Zoneは1aと1cに各2つずつEC2インスタンスを配置し２つのAvailability Zone跨ったマルチAZ構成を採用</li>
                    <li>DLMでEBSボリュームのスナップショットを毎日取得し、取得を完了したらSNSとGmailを使用して担当者へ通知する</li>
                    <li>画像の容量が増えることを想定し保存先・取り出し先東京リージョンのS3とする</li>
                    <li>インスタンスのCPU使用率が80%を超過した場合AutoScallingで自動スケーリングする。</li>
                    <li>管理サーバへのアクセス認証はCognitoを使用し、ユーザ名とパスワードで認証する。</li>
                    <li>インスタンスサイズはlargeを採用し、メモリ使用率を確保する。</li>
                    <li>他AWSリソースへのアクセス制限はS3へのアクセス許可するIAMポリシー・ロールをアタッチ</li>
                </ul>
            <h3>４,DBサーバの構成</h3>
                <ul>
                    <li>RDSを使用</li>
                    <li>マルチAZ構成によるマスタースレーブ構成を採用。1aをマスターとし、1cをスレーブとする</li>
                    <li>更新系はマスターを使用し、マスターがダウンした場合はスレーブへフェイルオーバーするよう設計</li>
                    <li>参照用はリードレプリカを使用し、読み込み負荷を分散する。
                        <br>通常時は2台のリードレプリカを使用するが、アクセス数によっては最大5台まで増設</li>
                        <br>
                    <li>自動バックアップの保持期間は7日間とする</li>
                </ul>
                <a href="#WEBサーバ構築の内容">先頭ページに戻る</a>
        <h2 id="監視設計">～監視設計～</h2>
            <ul>
                <li>CloudWatchを使用</li>
                <li>WEBサーバ・管理サーバのCPU使用率を監視し、閾値を3段階に設定。
                    <br>
                    監視設定：
                    <br>
                    80%、90%、99%に設定し、SNSとGmailを使って運用担当者へ通知。
                    <br>
                    また、80%を下回った場合は回復通知として運用担当者へ通知する。
                </li>
                <br>
                <li>死活監視としてインスタンスのステータスを監視。
                    <br>
                    監視設定：
                    <br>
                    ステータスが実行中以外の場合はSNSとGmailを使ってGmailにて通知。
                </li>
                <br>
                <li>CloudWatchのAllowedRequestsメトリクスとSNSによりWAFによる不正検知をいち早く担当者へ通知。
                    <br>
                    監視設定：
                    <br>
                    監視は5分間隔で監視し、１回以上不正なアクセスを検知した場合に通知</li>
            </ul>
            <a href="#WEBサーバ構築の内容">先頭ページに戻る</a>
</body>
</html>
